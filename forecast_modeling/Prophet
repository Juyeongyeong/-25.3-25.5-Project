#prophetì—ì„œ ë°˜ë“œì‹œ ìˆì–´ì•¼í•  ì¹¼ëŸ¼ ds : (datetime í˜•ì‹) / Y: ì˜ˆì¸¡í•˜ê³ ì í•˜ëŠ” ê°’ 
import pandas as pd
from prophet import Prophet
import matplotlib.pyplot as plt 
from matplotlib import rcParams

rcParams['font.family'] = 'AppleGothic'

df = pd.read_csv('Personal_Finance_Dataset.csv', encoding = 'utf-8-sig')
df['date'] = pd.to_datetime(df['Date'])

expense = df[df['Type'] == 'Expense'].copy()
print(expense.info())
expense['month'] = expense['date'].dt.to_period('M')

monthly = expense.groupby('month')['Amount'].sum().reset_index()


#Prophet í¬ë§·ìœ¼ë¡œ ì»¬ëŸ¼ ì´ë¦„ ë³€ê²½ / monthly['month']ëŠ” period í˜•ì‹-> prophetì—ì„œ ì¸ì‹ ë¶ˆê°€
monthly['ds'] = monthly['month'].dt.to_timestamp()
monthly['y'] = monthly['Amount']
prophet_df = monthly[['ds','y']]

model = Prophet()
model.fit(prophet_df)

#ë¯¸ë˜ ë‚ ì§œ ìƒì„±(1ê°œì›”)
future = model.make_future_dataframe(periods = 1, freq = 'M')

#ì˜ˆì¸¡ ìˆ˜í–‰
forecast = model.predict(future)

#ì˜ˆì¸¡ê°’ ì¶”ì¶œ
next_month_forecast = forecast[['ds', 'yhat']].tail(1)
predicted_value = int(next_month_forecast['yhat'].values[0])

#ì˜ˆì‚° ê¸°ì¤€
budget = 20000

print(f"ì˜ˆì¸¡ëœ ë‹¤ìŒ ë‹¬ ì§€ì¶œì•¡: {predicted_value:,}ì›")
if predicted_value > budget:
    print("ì˜ˆì‚°ì„ ì´ˆê³¼í•  ê²ƒìœ¼ë¡œ ì˜ˆìƒë©ë‹ˆ.")
else:
    print("ì˜ˆì‚° ë²”ìœ„ ë‚´ ì˜ˆì‚°ë©ë‹ˆë‹¤.")
    

# ì‹œê°í™”
fig = model.plot(forecast)
plt.axhline(y=budget, color='red', linestyle='--', label='ì˜ˆì‚° í•œë„')
plt.legend()
plt.title("Prophet ê¸°ë°˜ ì›”ë³„ ì§€ì¶œ ì˜ˆì¸¡")
plt.tight_layout()
plt.show()

#prophet ì˜ˆì¸¡ ê²°ê³¼ì™€ ì‹¤ì œê°’ ë¹„ 
from sklearn.metrics import mean_absolute_error, mean_squared_error
import numpy as np

#ì‹¤ì œê°’ : prophet_df['y']
#ì˜ˆì¸¡ê°’ : forecastì— ê³¼ê±° ë°ì´í„°ë§Œ ì„ íƒ 
forecast_actual = forecast[forecast['ds'] <= prophet_df['ds'].max()]
y_true = prophet_df['y'].values
y_pred = forecast_actual['yhat'].values

#MAPE, RMSE ê³„ì‚°
# MAPE í•¨ìˆ˜ ì •ì˜
def mean_absolute_percentage_error(y_true, y_pred):
    y_true, y_pred = np.array(y_true), np.array(y_pred)
    return np.mean(np.abs((y_true - y_pred) / y_true)) * 100

# MAE, RMSE, MAPE ê³„ì‚°
mae = mean_absolute_error(y_true, y_pred)
rmse = np.sqrt(mean_squared_error(y_true, y_pred))
mape = mean_absolute_percentage_error(y_true, y_pred)

print(f"ğŸ“Š MAE: {mae:,.0f}ì›") #í‰ê· ì ìœ¼ë¡œ ì–¼ë§ˆ ì°¨ì´ ë‚˜ëŠ”ì§€(ë‹¨ìœ„ ê·¸ëŒ€ë¡œ)
print(f"ğŸ“‰ RMSE: {rmse:,.0f}ì›") #í° ì˜¤ì°¨ ë” ë¯¼ê°í•˜ ë°˜ì‘
print(f"ğŸ“ˆ MAPE: {mape:.2f}%") #%ë¡œ í‘œí˜„ë˜ì–´ í•´ì„ì´ ì‰¬ì›€ (5% ì´í•˜ë©´ ë§¤ìš° ìš°ìˆ˜)
#MAPE 0~10% = ë§¤ìš° ìš°ìˆ˜, ~20% = ë³´í†µ, ~50% = ë¶€ì •í™•, ê·¸ ì´ìƒ = ê±°ì˜ ì“¸ ìˆ˜ ì—†ìŒ

ğŸ“Š MAE: 3,691ì›
ğŸ“‰ RMSE: 4,433ì›
ğŸ“ˆ MAPE: 19.39%
