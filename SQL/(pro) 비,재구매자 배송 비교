/*재구매자 vs 비재구매자 비교 분석*/
USE sql_project;

SELECT * FROM first_order;
SELECT count(customer_id) FROM orders;


SELECT * FROM customers;
SELECT * FROM orders;
-- 고객별 주문량
WITH b AS (
  SELECT 
    c.customer_unique_id, COUNT(o.order_id) AS order_count
  FROM customers c
  JOIN orders o 
  ON c.customer_id = o.customer_id
  GROUP BY 1
  HAVING order_count > 1
)
SELECT 
  b.customer_unique_id, 
  DATEDIFF(o.order_delivered_carrier_date, o.order_purchase_timestamp) as diff1,
  DATEDIFF(o.order_estimated_delivery_date, o.order_delivered_carrier_date) as diff2
FROM b
JOIN customers c
  ON b.customer_unique_id = c.customer_unique_id
JOIN orders o
  ON c.customer_id = o.customer_id
WHERE DATEDIFF(o.order_estimated_delivery_date, o.order_delivered_carrier_date) IS NOT NULL;


-- 재구매자 - 2997명 (히스토그램 비교, diff1은 실제 받은 날짜 - 구매 날짜 / diff2는 배달 받기로 한 날짜 - 실제 받은 날짜)
-- diff1 : 실제 배송에 걸린 기간
-- diff2 : diff < 0 - 지연 / diff > 0 - 지연 x
WITH b AS (
  SELECT 
    c.customer_unique_id, COUNT(o.order_id) AS order_count
  FROM customers c
  JOIN orders o 
  ON c.customer_id = o.customer_id
  GROUP BY 1
  HAVING order_count = 1
)
SELECT 
  b.customer_unique_id, 
  DATEDIFF(o.order_delivered_carrier_date, o.order_purchase_timestamp) as diff1,
  DATEDIFF(o.order_estimated_delivery_date, o.order_delivered_carrier_date) as diff2
FROM b
JOIN customers c
  ON b.customer_unique_id = c.customer_unique_id
JOIN orders o
  ON c.customer_id = o.customer_id
WHERE DATEDIFF(o.order_estimated_delivery_date, o.order_delivered_carrier_date) IS NOT NULL;
