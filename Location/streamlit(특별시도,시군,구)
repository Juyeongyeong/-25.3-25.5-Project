import pandas as pd
import streamlit as st
from geopy.geocoders import Nominatim
from geopy.distance import geodesic
import folium
from streamlit_folium import folium_static
import math
from geopy.exc import GeocoderTimedOut

# CSV íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
data = pd.read_csv("gggc.csv", encoding="euc-kr") #ì‹œë„êµ°
data1 = pd.read_csv("abcd.csv", encoding="utf-8-sig")

# ì‚­ì œí•  ì—´ ì´ë¦„ ì§€ì •
columns_to_delete = ['Unnamed: 3']  # ì˜ˆì‹œë¡œ 'ì—´1'ê³¼ 'ì—´2'ë¥¼ ì‚­ì œ

# íŠ¹ì • ì—´ ì‚­ì œ
data.drop(columns=columns_to_delete, inplace=False)

# ë”•ì…”ë„ˆë¦¬ë¡œ ë³€í™˜í•  ë¹ˆ dict ìƒì„±
location_dict = {}

# ë°ì´í„°í”„ë ˆì„ì„ ë”•ì…”ë„ˆë¦¬ í˜•íƒœë¡œ ë³€í™˜
for _, row in data.iterrows():
    special_city = row['íŠ¹ë³„ì‹œë„']
    district = row['êµ¬']
    dong = row['ë™']

    # íŠ¹ë³„ì‹œë„ í‚¤ê°€ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ ìƒˆë¡œ ìƒì„±
    if special_city not in location_dict:
        location_dict[special_city] = {}

    # êµ¬ í‚¤ê°€ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ ìƒˆë¡œ ìƒì„±
    if district not in location_dict[special_city]:
        location_dict[special_city][district] = []

    # 'ë™'ì´ nanì´ ì•„ë‹ˆë©´ ë™ì„ ì¶”ê°€
    if pd.notna(dong):
        location_dict[special_city][district].append(dong)

st.title("ìœ„ì¹˜ ê¸°ë°˜ ê¸°ê´€ ì¶”ì²œ")

# ì‹œë„ ì„ íƒ
selected_sido = st.selectbox("íŠ¹ë³„ì‹œ, ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”:", list(location_dict.keys()))

# ì‹œêµ° ì„ íƒ
if selected_sido:
    selected_gu = st.selectbox("ì‹œ, êµ°ì„ ì„ íƒí•˜ì„¸ìš”:", list(location_dict[selected_sido].keys()))
else:
    selected_gu = None

# ë™ ì„ íƒ
if selected_sido and selected_gu:
    selected_dong = st.selectbox("ë™ì„ ì„ íƒí•˜ì„¸ìš”:", location_dict[selected_sido][selected_gu])
else:
    selected_dong = None

# ì£¼ì†Œ ìƒì„±
parts = [selected_sido, selected_gu, selected_dong]
valid_parts = [str(part) for part in parts if pd.notnull(part) and part is not None and str(part).lower() != "nan"]
address = " ".join(valid_parts)

# ì„¸ ê°’ì´ ëª¨ë‘ ì¡´ì¬í•  ë•Œë§Œ geocode ì‹¤í–‰

# ì„¸ ê°’ì´ ëª¨ë‘ ì„ íƒë˜ì—ˆì„ ë•Œë§Œ geocode ì‹¤í–‰
if selected_sido and selected_gu and selected_dong:
    geolocator = Nominatim(user_agent="your_app_name")
    try:
        location = geolocator.geocode(address)
        st.success(f"ğŸ“ ì£¼ì†Œ: {address}")
        st.write(f"ìœ„ë„: {location.latitude}, ê²½ë„: {location.longitude}")
    except Exception as e:
        st.error(f"ì§€ì˜¤ì½”ë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")


current_location = (location.latitude, location.longitude)

# ê° ì¥ì†Œì™€ì˜ ê±°ë¦¬ ê³„ì‚° í•¨ìˆ˜
def calculate_distance(row):
    place_location = (row['ìœ„ë„'], row['ê²½ë„'])
    return geodesic(current_location, place_location).kilometers

# ê±°ë¦¬ ê³„ì‚° ë° ë°ì´í„°í”„ë ˆì„ì— ì¶”ê°€
data1['ê±°ë¦¬(km)'] = data1.apply(calculate_distance, axis=1)

# ê°€ì¥ ê°€ê¹Œìš´ ì¥ì†Œ 3ê°œ ì„ íƒ
closest_places = data1.nsmallest(3, 'ê±°ë¦¬(km)')

# ì§€ë„ ìƒì„±
mymap = folium.Map(location=current_location, zoom_start=15)

# í˜„ì¬ ìœ„ì¹˜ê°€ ê°€ì¥ ê°€ê¹Œìš´ ì¥ì†Œ ì¤‘ í•˜ë‚˜ì¸ì§€ í™•ì¸
is_current_location_closest = any(
    (abs(current_location[0] - row['ìœ„ë„']) < 1e-5) and (abs(current_location[1] - row['ê²½ë„']) < 1e-5)
    for _, row in closest_places.iterrows()
)

# í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ ì¶”ê°€
folium.Marker(
    current_location,
    popup='í˜„ì¬ ìœ„ì¹˜',
    icon=folium.Icon(color='blue' if is_current_location_closest else 'lightred', icon='cloud', prefix='fa')
).add_to(mymap)

# ë‚˜ë¨¸ì§€ ì¥ì†Œ ë§ˆì»¤ ì¶”ê°€ (ì—°í•œ ë‚¨ìƒ‰)
other_places = data1[~data1.index.isin(closest_places.index)]
for _, row in other_places.iterrows():
    folium.Marker(
        [row['ìœ„ë„'], row['ê²½ë„']],
        popup=folium.Popup(f'<div style="white-space: nowrap;"><a href="https://map.naver.com/v5/search/{row["ê¸°ê´€ëª…"]}" target="_blank">{row["ê¸°ê´€ëª…"]}</a></div>', max_width=300),
        icon=folium.Icon(color='lightblue')
    ).add_to(mymap)

# ê°€ì¥ ê°€ê¹Œìš´ ì¥ì†Œ ë§ˆì»¤ ì¶”ê°€ (ì§„í•œ ë‚¨ìƒ‰)
for _, row in closest_places.iterrows():
    folium.Marker(
        [row['ìœ„ë„'], row['ê²½ë„']],
        popup=folium.Popup(f'<div style="white-space: nowrap;"><a href="https://map.naver.com/v5/search/{row["ê¸°ê´€ëª…"]}" target="_blank">{row["ê¸°ê´€ëª…"]}</a></div>', max_width=300),
        icon=folium.Icon(color='darkblue')
    ).add_to(mymap)

# ì§€ë„ í‘œì‹œ
folium_static(mymap)


